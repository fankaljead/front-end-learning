# 计算机操作系统

[计算机操作系统](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20%E7%9B%AE%E5%BD%95.md)

## 1. 概述

**操作系统是一种软件，它的主要目的有三种**

- **管理计算机资源**，这些资源包括 CPU、内存、磁盘驱动器、打印机等。

- **提供一种图形界面**，就像我们前面描述的那样，它提供了用户和计算机之间的桥梁。

- **为其他软件提供服务**，操作系统与软件进行交互，以便为其分配运行所需的任何必要资源。

    ![image-20220320202444830](https://s2.loli.net/2022/03/20/8tMHYJ9zKWgkiEN.png)

### 1.1 基本特征

### 1.1.1 并发

- **并发是指宏观上在一段时间内能同时运行多个程序，**

- **而并行则指同一时刻能运行多个指令**。

并行需要硬件支持，如多流水线、多核处理器或者分布式计算系统。

操作系统通过引入进程和线程，使得程序能够并发运行。

### 1.1.2 共享

**共享是指系统中的资源可以被多个并发进程共同使用**。

有两种共享方式：**互斥共享和同时共享**。

互斥共享的资源称为临界资源，例如打印机等，在同一时刻只允许一个进程访问，需要用同步机制来实现互斥访问。

### 1.1.3 虚拟

**虚拟技术把一个物理实体转换为多个逻辑实体**。

**主要有两种虚拟技术：时（时间）分复用技术和空（空间）分复用技术**。

多个进程能在同一个处理器上并发执行使用了时分复用技术，让每个进程轮流占用处理器，每次只执行一小个时间片并快速切换。

虚拟内存使用了空分复用技术，它将物理内存抽象为地址空间，每个进程都有各自的地址空间。地址空间的页被映射到物理内存，地址空间的页并不需要全部在物理内存中，当使用到一个没有在物理内存的页时，执行页面置换算法，将该页置换到内存中。

### 1.1.4 异步

异步指进程不是一次性执行完毕，而是走走停停，以不可知的速度向前推进。

## 1.2 基本功能

### 1.2.1 进程管理

进程控制、进程同步、进程通信、死锁处理、处理机调度等。

### 1.2.2 内存管理

内存分配、地址映射、内存保护与共享、虚拟内存等。

### 1.2.3 文件管理

文件存储空间的管理、目录管理、文件读写管理和保护等。

### 1.2.4 设备管理

完成用户的 I/O 请求，方便用户使用各种设备，并提高设备的利用率。

主要包括缓冲管理、设备分配、设备处理、虛拟设备等。

## 1.3 系统调用

如果一个进程在用户态需要使用内核态的功能，就进行系统调用从而陷入内核，由操作系统代为完成。

![系统调用](https://s2.loli.net/2022/03/20/oRFe7vYMsZSTIXg.png)

Linux 的系统调用主要有以下这些：

| Task     | Commands                    |
| -------- | --------------------------- |
| 进程控制 | fork(); exit(); wait();     |
| 进程通信 | pipe(); shmget(); mmap();   |
| 文件操作 | open(); read(); write();    |
| 设备操作 | ioctl(); read(); write();   |
| 信息维护 | getpid(); alarm(); sleep(); |
| 安全     | chmod(); umask(); chown();  |

## 1.4 宏内核与微内核

### 1.4.1 宏内核

宏内核是将操作系统功能作为一个紧密结合的整体放到内核。

由于各模块共享信息，因此有很高的性能。

### 1.4.2 微内核

由于操作系统不断复杂，因此将一部分操作系统功能移出内核，从而降低内核的复杂性。移出的部分根据分层的原则划分成若干服务，相互独立。

在微内核结构下，操作系统被划分成小的、定义良好的模块，只有微内核这一个模块运行在内核态，其余模块运行在用户态。

因为需要频繁地在用户态和核心态之间进行切换，所以会有一定的性能损失。

![微内核](https://s2.loli.net/2022/03/20/xOQnliTZYadDqt6.jpg)

## 1.5 中断分类

**在程序运行过程中，系统出现了一个必须由CPU立即处理的情况，此时，CPU 暂时中止程序的执行转而理这个新的情况 的过程就叫做 中断。**

![中断分类](https://s2.loli.net/2022/03/20/ChWbpfZvVAiKouD.png)

### 1.5.1 外中断

由 CPU 执行指令以外的事件引起，如 I/O 完成中断，表示设备输入/输出处理已经完成，处理器能够发送下一个输入/输出请求。此外还有时钟中断、控制台中断等。

外中断常见的情况如`I/O中断`（由I/O控制器产生，用于发送信号通知操作完成等信号，比如进程需要请求打印机资源，打印机有一个启动准备的过程，准备好了就会给CPU一个I/O中断，告诉它已经准备好了）、`时钟中断`（由处理器内部的计时器产生，允许操作系统以一定规程执行函数，操作系统每过大约15ms会进行一次线程调度，就是利用时钟中断来实现的）。

### 1.5.2 异常

由 CPU 执行指令的内部事件引起，如非法操作码、地址越界、算术溢出等

### 1.5.3 陷入

在用户程序中使用系统调用。

**内中断** 常见的情况如`程序非法操作`(比如你要拿的的数据的内存地址不是内存地址，是系统无法识别的地址)，`地址越界`(比如系统给你的程序分配了一些内存，但是你访问的时候超出了你应该访问的内存范围)、`浮点溢出`(比如系统只能表示1.1到5.1的范围，你输入一个100, 超出了计算机能处理的范围)，或者`异常`，`陷入trap`（是指应用程序请求系统调用造成的）。

## 2. 进程管理

### 2.1 进程与线程

### 2.1.1 进程

**进程是资源分配的基本单位**。

进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。

下图显示了 4 个程序创建了 4 个进程，这 4 个进程可以并发地执行。

![进程](https://s2.loli.net/2022/03/20/4Ihm6OXap9nqsvd.png)

### 2.1.2 线程

**线程是独立调度的基本单位**。

一个进程中可以有多个线程，它们共享进程资源。

QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。

![线程](https://s2.loli.net/2022/03/20/O8FcZAPzXgjrt2J.png)

### 2.1.4 区别

- **拥有资源**

​		进程是资源分配的基本单位，但是线程不拥有资源，线程可以访问隶属进程的资源。

- **调度**

​		线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程中的线程切换到另		一个进程中的线程时，会引起进程切换。

- **系统开销**

​		由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I/O  设备等，所付出的开销远大于创		建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU  		环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。

- **通信方面**

​		线程间可以通过直接读写同一进程中的数据进行通信，但是进程通信需要借助 IPC。

## 2.2 进程状态的切换

![进程状态切换](https://s2.loli.net/2022/03/20/OC4KQ8lN39MnUdx.png)

- 就绪状态（ready）：等待被调度
- 运行状态（running）
- 阻塞状态（waiting）：等待资源

应该注意以下内容：

- **只有就绪态和运行态可以相互转换**，**其它的都是单向转换**。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。
- 阻塞状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU 时间，缺少 CPU 时间会从运行态转换为就绪态。

## 2.3 进程调度算法

